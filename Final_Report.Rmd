---
title: "Experimental_Methodology"
author: "Mark Paluta, Krysten Thompson, Chris Ventura"
date: "April 19, 2019"
output:
  word_document:
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, warning=FALSE}
library(data.table)
library(corrplot)
library(stargazer)
library(pwr)
library(sandwich)
library(lmtest)
```

# Introduction / Background / Motivation
<TODO>
- Clean up, properly cite sources
- Clearly state research question and hypothesis
- Expand summary at the end (<> sections)

**Statement of the research question; why this is interesting to someone who is predisposed to be interested; what other people know about this; what (if any) obsrevational work has to say about this question**


< Background info on difficulties for older people finding housing >
- Fair housing act does not explicitly ban age discrimination in housing (https://www.justice.gov/crt/fair-housing-act-1)
- NYT article on rise of roommates for adults over 30 (https://www.nytimes.com/2016/05/06/fashion/mens-style/adult-men-roommates-new-york.html)
- Atlantic article on rise of roomates (https://www.theatlantic.com/family/archive/2018/08/the-strange-unique-intimacy-of-the-roommate-relationship/567296/)
- Zillow research article on doubling up (https://www.zillow.com/research/rising-rents-more-roommates-17618/)

In a recent study, Zillow found that the share of adults living with a non-spouse, non-partnered roomate increased from 21% in 2005 to 30% at the end of 2017.  Whether it is due to changing attitudes about living with roommates, a neccesity due to increased rents in major cities, or some other factor, the trend is clear: more Americans are cohabitating with someone other than a spouse or partner.  While college and post-college aged urbanites often expect to have roommates, the trend is increasing for those older than 30, as a recent New York Times profile depicts.  As employment opportunities continue to cluster in dense metropolitan areas such as New York and San Francisco, an older cohort may be forced to cohabitate in order to pursue economic opportunity.

In spite of this demographic trend, little research has been done into whether the age of someone looking for a place to live with roommates has an impact on their options. As the New York Times profile describes, until recently the idea of having a roommate was mostly relegated to young professionals in their 20s.  

# Research Question

Through this experiment, we set out to determine if older professionals face a penalty when seeking a roommate compared to someone in their 20's. We investigate whether age affects replies when responding to a roommate posting on Craigslist as well as determine whether age has a statistically significant effect on the odds of what we will call a "favorable reply".

We hypothesized that the "older" age treatment would receive fewer favorable replies than the 20-something treatment.

# Initial Experiment Idea

Our initial experiment sought to test gender and age discrimination. We created two email accounts for a female (age 27 and 43) and two email accounts for a male (age 27 and 43). We chose these ages to avoid round numbers, have the 20-something presumed to be slightly more established in a job/career than someone who is 22 or 23 (too young of an age may have caused bias), and have the older person at least over 40 but not yet 45 which may have caused bias as well. 

We also considered running this experiment in several different cities in the U.S. to see if regional differences exist in terms of gender and age.

A pilot was conducted in early March to determine if our initial approach would work and identify potential obstacles. We discovered issues with Craigslist and Gmail fraud mechanisms that led us to modify our approach. See Pilot Study below for further details. 

## Pilot Study and Outcomes

We conducted a pilot study for three days to identify any problems that may surface during the full study. Major learnings from the pilot:

1) VPNs are not particularly compatible with Craigslist. We initially wanted to use a VPN to avoid being flagged as fraud by Craigslist. We tried several but Craigslist still flagged us as fraud when it detected that we changed email accounts.

2) Google sent one of our accounts a notification that it was shutting down one of our accounts because it detected the account was not being used according to Google's guidelines. 

We concluded that maintaining too many personas would be difficult due to concerns about tripping fraud algorithms and getting our real IP addresses blacklisted. As a result, we decided to limit our full study to 2 females. We theorized that females would have higher response rates due to more postings seeming open to females, and suspected that males would be more willing to live with females than females would be willing to live with males.

Not all posts seemed appropriate for measuring effects on a typical applicant. The following types of posts were excluded:

  a) Posts with sexual implications including "friends with benefits", reduced rent in exchange for sex 
  b) Posts soliciting other favors in exchange for reduced rent such as babysitting
  c) Posts for students only
  d) Posts without an email option or posts explicitly stating that email replies will not be answered
  e) Posts explicitly stating males only


# Experiment Design & Methodology

The experiment design consisted of sending emails to listings under the Craigslist heading "Housing" > "Rooms/Shared". 

In order to be able to draw conclusions that could be somewhat generalized to the US population, Indianapolis was selected as the target market. Indianapolis is a mid-sized city located in the midwest.

We sent emails every 1-3 days across a two-week time period. We were not particularly concerned with the exact times or days we collected data since we were collecting a number of time-based covariates in order to not confound our results with any temporal effects. We did make a conscious effort to cover a broad range of variation in our temporal covariates by sending emails on every day of the week and including a mix of morning, afternoon, and evening collections.

The following procedure was implemented each time emails were sent:

1) Open all postings since the last data collection (or fewer if subject to time constraints, prioritizing recent postings)
2) Go through each post and throw out any that meet our exclusion criteria
3) Obtain a count of the number of included (remaining) posts
4) Randomize an array assigning these posts to our 27-year-old or 43-year-old persona.
5) Beginning with the first persona in the array, log into their respective email account and begin emailing posters in order from most recent to least, recording covariates as we go

Emails were sent only to listings that were new, or listings that had been posted days or weeks ago but were "refreshed" in the postings list. There were only 1-2 instances where a listing received more than one "Katie" email and those observations were deleted from the final data set.

A short R radomization function was run prior to sending out the emails to radomize which listing would receive a "Katie 27" or "Katie 43" email.

The following was collected by manually entering data in a Google Sheet:

- Listing post date/time
- Email sent to listing date/time
- Treatment (Katie 27, Katie 43)
- Listing title, description
- Age and gender of person posting listing (if avail)
- Whether reply was received, along with date/time
- Whether reply was favorable

Favorable replies were defined as those received within 72 hours of a "Katie" email being sent and suggesting a time to show the unit or asking "Katie" for more information. An unfavorable reply stated the unit was already rented. 

Email Text:

Hi,

I saw your listing and it sounds like it might be ideal. Iâ€™m Katie, 43 years old, employed, tend to keep my place pretty tidy, and enjoy cooking and running. When would I be able to see the room in person?

Thanks, Katie


<TODO>

**Add screenshot of email**
- Add flow diagram
<Add diagram of response flows (emails/listing -> replies -> favorable replies)>
 **Clear statement of the experiment**

    Research Design (using ROXO grammar)
    Randomization engineering
    Experimental materials (e.g. treatment materials)
    Measurement of variables
    Modeling choices
**end**


# Data

## Data Types

```{r include=FALSE}
#df = read.csv("Data_Collection_Sheet.csv", fileEncoding="UTF-8-BOM")
d <- read.csv("craigslist.csv", stringsAsFactors = FALSE)
d$email_sent_date = NULL
d$email_sent_time = NULL
d$post_date = NULL
d$post_time = NULL
d$reply_date = NULL
d$reply_time = NULL
```

We collected the following variables, spanning posting metadata, contents for archiving purposes, time information for temporal effects, covariates, and treatment applied. As we were not sure how clean our data would be and what would prove useful, we erred on the side of collecting lots of data and downselecting later.

```{r, include=FALSE}
sum(is.na(d$poster_age))/nrow(d)
sum(is.na(d$poster_gender))/nrow(d)
sum(is.na(d$list_type))/nrow(d)
sum(is.na(d$list_price))/nrow(d)
```

| Variable             | Description                       | Example                                    | % Missing |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Post Title           | Title of the Craigslist post      | Roommate/shared house ASAP                 | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Post Body            | Body of the Craigslist post       | ALL INCLUSIVE 10 minutes from downtown...  | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Post URL             | URL of the Craigslist post        | https://indianapolis.craigslist.org...     | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Poster Age           | Age of the resident who posted    | 34                                         | 81%       |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Poster Gender        | Gender of the resident who posted | Female                                     | 64%       |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Listing Type         | Type of residence                 | Apartment                                  | 8%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Listing Price        | Price of the listing              | $450                                       | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Posting Timestamp    | Timestamp that the post went up   | 3/21/2019 22:38                            | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Email Sent Timestamp | Timestamp that we emailed         | 3/22/2019 6:59                             | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Treatment            | Which alias we emailed from       | Katie 27                                   | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Reply                | Did we receive a reply?           | Y                                          | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Favorable Reply      | Did we receive a favorable reply? | Y                                          | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Reply Timestamp      | Timestamp of a reply, if received | 3/23/2019 16:53                            | 0%        |
|----------------------|-----------------------------------|--------------------------------------------|-----------|
| Weekend              | Was our email sent on a weekend?  | Y                                          | 0%        |

In total, we sent `r nrow(d)` emails - `r sum(d$treatment=="katie_27")` for "Katie 27"" and `r sum(d$treatment=="katie_43")` for "Katie 43". For several of these variables, we had significant missing data and decided we would not be able to make use of them in modeling. In particular, we think poster age and gender could have been predictive had they been more complete. Our hypothesis would be that all else being equal, people prefer to live with those of the same gender or age.

<!-- This below is fake data, but I was going to see if gender was showing an increase in response rate. I'll try to come back to this or else will delete it -Mark  -->

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(xtable)
gender_df = data.frame("Poster Gender" = c("Female","Male"),"Katie 27" = c(23, 55))
#xtable(gender_df, caption="Response rate by treatment and gender")
options(xtable.comment = FALSE)
print(xtable(gender_df, caption="Response rate by treatment and gender"), include.rownames=FALSE)
```

Since some replies we received did contain further information, which sometimes included a name, age, or gender, we considered filling in some missing data from replies where possible. We eventually decided against this for a few reasons. First, we still would not get close to 100% completeness on those variables and would need a separate category for "Unknown" and introducing imputations from responses only might even require an additional category. We thought that getting more covariate data from _the types of people_ who were replying to our emails would distort the relationship between that covariate and probability of a reply. This could bias the effect of the covariate and in turn bias our estimate of the treatment effect. Finally, since this information is not readily available to someone browsing Craigslist, it is of limited use to them because by the time they receive it, they already have their reply. 

**<TODO>**
**- Mention how we removed duplicates**

## Data Transformations

**<TODO>**
**- Describe any transformations or cleanup steps that would be interesting to a reader**

```{r cleaning, include=FALSE}
# Timestamps
d$sent_timestamp <- as.POSIXct(d$sent_timestamp,format="%m/%d/%Y %H:%M", tz="EST")
d$post_timestamp <- as.POSIXct(d$post_timestamp,format="%m/%d/%Y %H:%M", tz="EST")
d$reply_timestamp <- as.POSIXct(d$reply_timestamp,format="%m/%d/%Y %H:%M", tz="EST")

# Timestamp distances
d$hours_post_to_email <- as.numeric(difftime(d$sent_timestamp,d$post_timestamp, units="hours"))
d$hours_email_to_reply <- as.numeric(difftime(d$reply_timestamp,d$sent_timestamp, units="hours")) # Note - not used will remove

# Age
d$poster_age = as.numeric(d$poster_age)

# Combine list_types
d <- within(d, list_type[list_type == 'townhouse'] <- 'house')
d <- within(d, list_type[list_type == 'condo'] <- 'apartment')
d$list_type[is.na(d$list_type)] <- 'unknown'
d$list_type = as.factor(d$list_type)

# Create weekend variable
d$sent_is_weekend <- ifelse(d$email_sent_dow %in% c(1,6,7), 1, 0)

# Binarize outcome
d <- within(d, {
  fave_reply = ifelse(fave_reply == "Y", 1, 0)
})
```

**<TODO>**
**- Do some initial data descriptions**
**- Include any plots that make sense and comment on them**

>

```{r EDA}
# I think for these next two, probably plot side by side to show the effect of log transformation

# h.1 <- ggplot(d, aes(x=list_price)) + geom_histogram()
# h.2 <- ggplot(d, aes((x=log(list_price)) + geom_histogram()))
# grid.arrange(h.1, h.2, ncol=1)

hist(d$list_price)
hist(log(d$list_price))

hist(log(d$hours_post_to_email))
hist(log(d$hours_post_to_email))

# create temporary dataframe casting categorical vars as 0-1 to allow corrplot
# d_temp <- within(d_sub, {
#   list_type = ifelse(list_type == "house", 1, 0)
#   treatment = ifelse(treatment == "katie_27", 1, 0)
#   #reply = ifelse(reply == "Y", 1, 0)
#   fave_reply = ifelse(fave_reply == "Y", 1, 0)
# })
# correlations = cor(na.omit(d_temp[, c('list_price', 'list_type', 'treatment', 'fave_reply', "mins_post_to_email")]))
# corrplot(correlations, method="color", type="upper", addCoef.col = "black",
#          col=colorRampPalette(c("#BB4444",  "#FFFFFF", "#4477AA"))(200))
```

# Results

## Summary Results
<!-- love these next two, but thinking results section -Mark -->
**- Two bars, side by side, with probability of favorable replies and error margins** 
- needs code and interpretation
**- line chart showing probability of favorable reply based on sent time for treatment and control**
- needs code and interpretation

## Regression

To estimate our treatment effects, we employed a variety of regression specifications.  All of the regression specificaitons followed the following equations:

<Add equation in latex>

We used a linear regression for each of our four regression specifications, regressing the binary variable of a favorable reply on our treatment and, for the first three specifications, our chosen covariates.  While our outcome variable is binary, using a linear regression allows us to directly measure the expected change in probability of getting a favorable reply, with the coefficients of the independent variables corresponding to the probability increase or decrease.

**<Should we reverse this?  I feel like most papers I see usually have the reverse order (treatment only first, full gamut last)>**

The first regression regresses favorable reply on the treatment, the log of list price, binary indicators for house and unknown list types (leaving apartments as the default), the log of hours between the post time and email sent, and a binary indicator indicating if the treament or control email was sent on a weekend.  Given that we have only 113 observations, we were wary of including all of our variables for fear of overfitting our regressions and to preserve degrees of freedom.  A number of our variables were sparsely populated, so we selected these variables based on their near complete population for all observations as well as likelihood of explaining variations in a poster's response.  We chose to take the log of list price due to a skew in the values and the log of hours between post time and email sent for ease of interpretability

The second regression specification removes the variables associated with listing price and type, leaving only the treatment variable, the log of hours between post time and the email sent, and the binary indicator of the email being sent on the weekend.  This regression specification is meant to help ensure that we randomized effectively and that varibales related to the listing type were not correllated with the treatment.

The third regression leaves only treatment and the log of hours between post time and the email being sent.  We will detail this in the next section, but we wanted to ensure the only statistically significant covariate had no impact on the treatment effect.

Finally, the fourth regression contains only the treatment variable.

<remove summaries with working stargazer>
```{r}
# model 1: exhaustive regression
model.1 = lm(fave_reply ~ treatment+log(list_price)+list_type+log(hours_post_to_email)+sent_is_weekend, data=d)
model.1.robust <-coeftest(model.1, vcov = vcovHC(model.1, type="HC"))
model.1.robust
cov1 <- vcovHC(model.1, type = "HC")
robust.se.1 <- sqrt(diag(cov1))

# model 2: removing list type and price (rationale - maybe correlated with weekend sent)
model.2 = lm(fave_reply ~ treatment+log(hours_post_to_email)+sent_is_weekend, data=d)
model.2.robust <-coeftest(model.2, vcov = vcovHC(model.2, type="HC"))
model.2.robust
cov2 <- vcovHC(model.2, type = "HC")
robust.se.2 <- sqrt(diag(cov2))

# model 3: only treatment and hours_post_to_email (the only significant covariate)
model.3 = lm(fave_reply ~ treatment+log(hours_post_to_email), data=d)
model.3.robust <- coeftest(model.3, vcov = vcovHC(model.3, type="HC"))
model.3.robust
cov3 <- vcovHC(model.3, type = "HC")
robust.se.3 <- sqrt(diag(cov3))

# model 4: treatment only
model.4 = lm(fave_reply ~ treatment, data=d)
model.4.robust <- coeftest(model.4, vcov = vcovHC(model.4, type="HC"))
model.4.robust
cov4 <- vcovHC(model.4, type = "HC")
robust.se.4 <- sqrt(diag(cov4))

#plot(model.1)
#plot(model.2)
#plot(model.3)
#plot(model.4)
```


``` {r stargazer, results='asis'}
stargazer(model.1, model.2, model.3, model.4, se=c(robust.se.1, robust.se.2, robust.se.3, robust.se.4))
```

Examining the results of the four regression specifications, we see a fairly consistent treatment effect ranging from `r round(model.1.robust['treatmentkatie_43','Estimate'], 2)` to `r round(model.4.robust['treatmentkatie_43','Estimate'], 2)`.  This suggests that our randomization worked appropriately, and that the effect of being a 43 year old female as opposed to a 27 year old females was to reduce the probability of receiving a response to roommate listing inquiries by `r abs(round(model.4.robust['treatmentkatie_43','Estimate'], 2))` to `r abs(round(model.1.robust['treatmentkatie_43','Estimate'], 2))`.  In spite of this practical significance, however, this result lacked statistical signifiance for all four model specifications with p-values ranging from `r round(model.1.robust['treatmentkatie_43','Pr(>|t|)'], 2)` to `r round(model.4.robust['treatmentkatie_43','Pr(>|t|)'], 2)`.

**<Please check my interpretation of the log values>**
In fact, the only variable to show any statistical significance in our model specifications is the log of hours between the post time and the sending of our treatment or control email. The coefficients of `r round(model.1.robust['log(hours_post_to_email)','Estimate'], 2)` to `r round(model.3.robust['log(hours_post_to_email)','Estimate'], 2)` suggests that a 100% increase in response time corresponds with a `r round(model.1.robust['log(hours_post_to_email)','Estimate'], 2)*100`% to `r round(model.3.robust['log(hours_post_to_email)','Estimate'], 2)*100`% change in likelihood of a response.


## Power Calculations

To better understand if and how our experiment might be lacking in power, we ran a 2-Sample Z-test and Power Tests. The Z-test indicates any differences in the proportions between Katie_27 and Katie_43 receiving a favorable reply. Z-test results:

```{r echo=FALSE, include=FALSE}

# fave_27 <- d[ which(d$fave_reply==1 & d$treatment=='katie_27'), ]
# sum(fave_27$fave_reply) #total = 33
# 
# fave_43 <- d[ which(d$fave_reply==1 & d$treatment=='katie_43'), ]
# sum(fave_43$fave_reply) #total = 29

res <- prop.test(x = c(33, 29), n = c(113, 113))
res
```

Estimated probability of success:

            Katie_27    $0.292$
            Katie_43    $0.257$
            
P-value:  $0.655$

Confidence Interval at 95%:  $-0.09$ - $0.16$

The high p-value of $0.66$, combined with a confidence interval wide enough to have both estimates of the probability of success overlap, leads to a conclusion that the proportion of favorable replies between the two Katies' is not significantly different.

We then look at two power tests, one test to calculate the number of observations we would need to obtain for *each* treatment, the other test to determine the required difference between the outcome variable (favorable replies) in order to observe a statistically significant effect from only 113 observations.

```{r echo=FALSE}
power_n <- pwr.t.test(d=0.022, sig.level=0.05, power=.8)
power_n
power_d <- pwr.t.test(n=113, sig.level=0.05, power=.8)
power_d
```

We would need an $n$ of `r round(as.numeric(power_n['n']),0)` (or 32,434 observations *per treatment*) for our results to be statistically significant. In order to be able to observe a statistically significant effect in age on the outcome variable 'favorable replies' using only 113 observations, the treatment effect would need to be `r round(as.numeric(power_d['d']),2)`, nearly twenty times our observed effect.  

Power increases as $N$ size or effect size go up, and/or standard deviation is reduced.  Because of the requirement of over $32,000$ observations needed for each treatment, in addition to being unsure the treatment effect would be as high as $37\%$, we conclude that for this particular research project, we do not find any meaningful difference in the rate of favorable replies based on age. 



## Randomization Inference

```{r}
d_dt <- data.table(d)

reply_treatment <- d_dt[treatment=="katie_43", mean(fave_reply==1)]
reply_base <- d_dt[treatment=="katie_27", mean(fave_reply==1)]
ate <- reply_treatment - reply_base
print(ate)
```


```{r}
iter <- 10000
ate_vec <- rep(NA, length(iter))
for(i in 1:iter){
d_dt[, success_rand := sample(c(0,1), size = .N, replace=TRUE)]
ate_vec[i] <- as.numeric(d_dt[ , .('success_mean' = mean(fave_reply==1)), keyby =.(success_rand)][ , .('ate' = diff(success_mean, lag=1, differences=1))])
}
```

```{r}
ri <- table(ate_vec<ate)
ri
```

In addition, we also used randomization inference to examine the probability of calculating our treatment effect by chance.  Examining the difference in means, we calculate an average treatment effect of `r round(ate,4)`.  Running randomization inference with `r iter` iteractions, we find `r as.numeric(ri[2])` random iterations with at least as significant a treatment effect as our actual.  This implies a p-value of `r as.numeric(ri[2]) / as.numeric(iter)`, a non-statistically significant result.  This is consistent with our linear regression results showing a non-statistically significant treatment effect.



# How We Would Re-do the Experiment




# Conclusions

As evidenced by the outputs of our various analyses, we do not find significant evidence that being a 43 year old female garners fewer responses to roommate inquires than being a 27 year old female in Indianapolis.  While we found an impact of between`r round(model.1.robust['treatmentkatie_43','Estimate'], 2)` to `r round(model.4.robust['treatmentkatie_43','Estimate'], 2)`, a practically signficant result, the result lacked statistical signficance in all four of our model specifications, as well as our randomization inference scenario.  Thus, we fail to reject our null hypothesis that both ages of females garner the same response rate.

While our experiment found no effect, we believe this result is significant in its own right.  We originally set out to study age bias in roommate searches and our experiment provides evidence against such bias.  This result could mean that there is one less barrier posed by age in pursuing economic opporunties, and perhaps public policy programs should focus on more pronounced room for bias.

We recommend a variety of future areas of study to expand upon this research.  First and foremost, we recommend this study be replicated over a longer time period in a variety of markets, not just Indianapolis.  This could help prove the generalizability of our findings.  Second, we'd recommend testing a variety of ages.  We kept our experiment simple due to time constraints, but examining a continuous span of ages rather than simply two could elucidate more interesting results.  Finally, while we limited our experiment to examining age, this experiment could easily be replicated to examine race, gender, sexual orientation, or a variety of other demographic factors.  Perhaps some segments of these groups does face significant descrimination when searching for a roommate.  Given the feasibility of conducting these experiments on platforms such as Craigslist we would highly recommend this as an area of future research.

**Clear statement of results**
    In text description of your results
    Figures and tables that support your in text description
    Clean, clear, well articulated relationships between your theory, your hypotheses, the numbers that your models produce, and the figures you present.
**end**
